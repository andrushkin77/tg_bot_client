<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç¬†–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
    body{background:#161616;color:#fff;padding:20px}
    .container{max-width:500px;margin:0 auto;background:#1e1e1e;
               padding:20px;border-radius:15px}
    .offer{padding:15px;background:#292929;margin:15px 0;border-radius:5px}
    .offer h3{margin:0 0 10px}
    .offer p{margin:0 0 10px}
    .offer button{width:100%;padding:10px;border:none;border-radius:5px;
                  cursor:pointer;font-weight:bold}
    .details-btn{background:#555;color:#fff;margin-top:6px}
    .choose-btn {background:#32CD32;color:#fff}
    .no-offers{text-align:center;margin-top:20px}
  </style>
</head>
<body>
<div class="container">
  <h2>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç¬†–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</h2>
  <div id="offersContainer">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
</div>

<script>
  const tg = Telegram.WebApp; tg.expand();

  const rawId  = new URLSearchParams(location.search).get('order_id') ?? '';
  const orderId = parseInt(rawId.trim(), 10);
  if (!orderId) {
    document.getElementById('offersContainer')
            .innerText = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: "' + rawId + '"';
    throw new Error('Bad order_id');
  }

  const apiBase = 'https://ytvybw-169-150-209-165.ru.tuna.am/api';

  // üîá –æ—Ç–∫–ª—é—á–∏–ª–∏ debug
  // function debug(text){}

  function acceptOffer(pid, price){
    fetch(`${apiBase}/accept_offer`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({order_id:orderId, partner_id:pid, price})
    })
    .then(r=>r.json())
    .then(j=>{
      if(j.status!=='success'){ alert(j.message||'–û—à–∏–±–∫–∞'); return; }
      location.href = `order_checkout.html?order_id=${orderId}&partner_id=${pid}`;
    })
    .catch(()=>alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'));
  }

  const viewDetails=(pid,offId)=>
    location.href =
      `order_detail_client.html?partner_id=${pid}&offer_id=${offId}&order_id=${orderId}`;

  function loadOffers(){
    const url = `${apiBase}/offers?order_id=${orderId}`;

    fetch(url)
      .then(r=>r.json())
      .then(data=>{
        const box = document.getElementById('offersContainer');
        box.innerHTML = '';

        if(!data.offers?.length){
          box.innerHTML = '<p class="no-offers">–ü–æ–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–µ—Ç.</p>';
          return;
        }

        data.offers.forEach(o=>{
          const div=document.createElement('div'); div.className='offer';
          div.innerHTML = `
            <h3>${o.partner_name}</h3>
            <p>–°—Ç–æ–∏–º–æ—Å—Ç—å: <strong>${o.price}¬†—Ä—É–±.</strong></p>
            <button class="choose-btn"
                    onclick="acceptOffer(${o.partner_id}, ${o.price})">
              –í—ã–±—Ä–∞—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
            </button>
            <button class="details-btn"
                    onclick="viewDetails(${o.partner_id}, ${o.id})">
              –°–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏
            </button>`;
          box.appendChild(div);
        });
      })
      .catch(()=>{
        document.getElementById('offersContainer')
                .innerText='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.';
      });
  }
  loadOffers();
</script>
</body>
</html>
