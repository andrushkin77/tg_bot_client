<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body  { background:#161616; color:#fff; font-family:Arial,sans-serif; padding:20px }
    .container { 
      background:#1e1e1e; padding:20px; border-radius:10px; 
      position:relative; /* –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ */
    }
    textarea, button { width:100%; padding:10px; margin-top:10px; border:none; border-radius:5px }
    textarea { background:#292929; color:#fff }
    /* –æ—Å–Ω–æ–≤–Ω–∞—è –∑–µ–ª—ë–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
    .primary-btn { background:#32CD32; color:#fff; font-weight:bold }
    /* –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è ¬´–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ¬ª  */
    .ghost-btn   {
      background:rgba(255,255,255,0.08); /* –ª—ë–≥–∫–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
      color:#fff;
      backdrop-filter:blur(4px);
      border:1px solid rgba(255,255,255,0.15); /* —Ç–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
      display:flex; align-items:center; gap:8px; justify-content:center;
    }
    .ghost-btn:hover { background:rgba(255,255,255,0.15) }
    /* ‚úèÔ∏è –∫–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    .edit-btn {
      position:absolute; top:20px; right:20px;
      background:none; border:none; color:#32CD32;
      font-size:24px; cursor:pointer; line-height:1;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- –ö–Ω–æ–ø–∫–∞ ‚úèÔ∏è –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ, –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º -->
  <button id="editImageBtn" title="–ü–æ–º–µ–Ω—è—Ç—å —Ñ–æ—Ç–æ" class="edit-btn">‚úèÔ∏è</button>
  <h2>–í–∞—à –∑–∞–∫–∞–∑</h2>

  <img id="orderImage" style="width:100%;border-radius:10px" alt="–§–æ—Ç–æ –∑–∞–∫–∞–∑–∞">

  <!-- 1. –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è -->
  <label style="margin-top:15px">–í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è:</label>
  <textarea id="wishes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å –∫—Ä–∞—Å–Ω—ã–µ —à–∞—Ä—ã..."></textarea>

  <!-- 2. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ  -->
  <button class="ghost-btn" style="margin-top:10px" onclick="openDeliveryPage()">
    üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ
  </button>

  <!-- 3. —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑ -->
  <button class="primary-btn" style="margin-top:15px" onclick="submitOrder()">
    –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –∑–∞–∫–∞–∑
  </button>
</div>

<script>
  const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
  if(tg) tg.expand();

  /* ----------------------------- —Ñ–æ—Ç–æ ----------------------------- */
  let imageUrl = new URLSearchParams(location.search).get('image_url');
  if (imageUrl) localStorage.setItem('image_url', imageUrl);
  else          imageUrl = localStorage.getItem('image_url');
  orderImage.src = imageUrl;

  /* -------------------------- –ø–æ–∂–µ–ª–∞–Ω–∏—è --------------------------- */
  const wishesEl = document.getElementById('wishes');
  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
  wishesEl.value = localStorage.getItem('wishes_text') || '';
  wishesEl.addEventListener('input', () => {
    localStorage.setItem('wishes_text', wishesEl.value);
  });

  /* ------------------------ —Å—Ç—Ä–∞–Ω–∏—Ü—ã / –¥–µ–π—Å—Ç–≤–∏—è ------------------- */
  function openDeliveryPage(){
    localStorage.setItem('wishes_text', wishesEl.value);
    const id = localStorage.getItem('order_id');
    location.href = id ? `delivery.html?order_id=${id}` : 'delivery.html';
  }

  function submitOrder(){
    const d = JSON.parse(localStorage.getItem('deliveryData')||'{}');
    const payload = {
      action:'submit_order', image_url:imageUrl,
      wishes:wishesEl.value, city:d.city,
      deliveryAddress:d.address,
      recipient_name:d.recipient_name,
      recipient_phone:d.recipient_phone
    };
    if(tg){ tg.sendData(JSON.stringify(payload)); tg.close(); }
    else { alert('–§–æ—Ä–º–∞ –∑–∞–∫—Ä—ã—Ç–∞: '+JSON.stringify(payload)); }
  }

  /* ----------------------- —Å–º–µ–Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ ----------------------- */
  editImageBtn.onclick = () => {
    if(!tg){ alert('–°–º–µ–Ω–∞ —Ñ–æ—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑ Telegram'); return; }
    if(confirm('–•–æ—Ç–∏—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏?')){
      localStorage.removeItem('image_url');
      localStorage.removeItem('wishes_text');
      tg.sendData(JSON.stringify({action:'edit_image'}));
      tg.close();
    }
  };
</script>
</body>
</html>
