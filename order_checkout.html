<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Ваш заказ</title>
  <!-- Подключаем Telegram WebApp JS (важно для работы внутри Телеграма) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background-color: #161616;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h2 {
      margin-bottom: 15px;
      font-size: 20px;
    }
    .order-box {
      background: #1E1E1E;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .order-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .order-header img {
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    .order-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .order-body strong {
      font-size: 16px;
    }
    .order-body textarea {
      background: #2A2A2A;
      border: none;
      border-radius: 5px;
      padding: 10px;
      color: #fff;
      resize: vertical;
    }
    .executor-box {
      background: #1E1E1E;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .executor-box .executor-name {
      font-size: 16px;
      font-weight: bold;
    }
    .executor-box button {
      background: #32CD32;
      border: none;
      border-radius: 5px;
      padding: 8px 12px;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    .pay-button {
      width: 100%;
      background: #32CD32;
      border: none;
      border-radius: 5px;
      padding: 15px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    /* Модальное окно */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #1E1E1E;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }
    .modal-content h3 {
      margin-bottom: 10px;
    }
    .modal-content p {
      margin-bottom: 10px;
    }
    .modal-content .field {
      background: #2A2A2A;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .modal-content .field:hover {
      background: #333;
    }
    .modal-content button {
      margin-top: 10px;
      padding: 10px;
      background: #32CD32;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      color: #fff;
      font-weight: bold;
    }
    .modal-content .cancel-btn {
      background: #444;
      margin-top: 5px;
    }
    /* Субмодальное окно */
    .submodal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1100;
    }
    .submodal-content {
      background: #1E1E1E;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    .submodal-content h3 {
      margin-bottom: 10px;
    }
    .submodal-content input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      background: #2A2A2A;
      color: #fff;
    }
    .submodal-content button {
      padding: 10px;
      background: #32CD32;
      border: none;
      border-radius: 5px;
      width: 100%;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- "Ваш заказ" -->
  <div class="order-box">
    <div class="order-header">
      <img id="balloonIcon" src="https://cdn-icons-png.flaticon.com/512/1761/1761370.png" alt="Баллоны">
      <h2>Ваш заказ</h2>
    </div>
    <div class="order-body">
      <!-- Название композиции -->
      <strong id="compositionName"></strong>
      <!-- Комментарий (редактируемый, но пока сохраняем только в localStorage) -->
      <textarea id="clientComment" rows="3" placeholder="Добавьте комментарий..."></textarea>
    </div>
  </div>
  
  <!-- "Ваш исполнитель" -->
  <div class="executor-box">
    <div class="executor-name" id="executorName">Исполнитель не выбран</div>
    <button id="showPartnerDetailsBtn">Смотреть детали</button>
  </div>
  
  <!-- Кнопка "Оплатить" -->
  <button class="pay-button" id="payBtn">Оплатить</button>
</div>

<!-- Модальное окно -->
<div class="modal-overlay" id="checkoutModal">
  <div class="modal-content">
    <h3>Подтверждение заказа</h3>
    <p id="orderNumber">Заказ №...</p>
    <p id="orderDescription"></p>
    <p id="deliveryInfo">Доставка: ...</p>
    <p id="orderTotal">Итого: ... руб.</p>

    <div class="field" onclick="openSubModal('delivery')">Информация о доставке</div>
    <div class="field" onclick="openSubModal('name')">Имя</div>
    <div class="field" onclick="openSubModal('phone')">Телефон</div>

    <button onclick="confirmPayment()" id="confirmPaymentBtn">Оплатить</button>
    <button class="cancel-btn" onclick="closeCheckout()">Отмена</button>
  </div>
</div>

<!-- Субмодальное окно -->
<div class="submodal-overlay" id="subModal">
  <div class="submodal-content">
    <h3 id="subModalTitle">Редактирование</h3>
    <input type="text" id="subModalInput" placeholder="">
    <button onclick="closeSubModal()">Готово</button>
  </div>
</div>

<script>
  /* --- Telegram WebApp --- */
  let tg;
  if (window.Telegram && Telegram.WebApp) {
    tg = Telegram.WebApp;
    tg.expand();
  } else {
    console.log("Запуск вне Telegram WebApp");
  }

  /* --- LocalStorage и данные --- */
  const compositionNameLS = localStorage.getItem('compositionName') || "Романтический сюрприз";
  const clientCommentLS = localStorage.getItem('clientComment') || "";
  const deliveryData = JSON.parse(localStorage.getItem('deliveryData') || '{}');
  const selectedPartner = JSON.parse(localStorage.getItem('selectedPartner') || '{}');

  document.getElementById('compositionName').innerText = `Композиция: "${compositionNameLS}"`;
  document.getElementById('clientComment').value = clientCommentLS;

  if (selectedPartner && selectedPartner.name) {
    document.getElementById('executorName').innerText = selectedPartner.name;
  }

  // Пример персонализации иконки
  document.getElementById('balloonIcon').title = `С праздником, ${selectedPartner.name || "друг"}!`;

  /* --- Загрузка деталей заказа из БД --- */
  const urlParams = new URLSearchParams(window.location.search);
  const orderId = urlParams.get('order_id');

  function loadOrderDetails() {
    if (!orderId) {
      console.error("order_id не найден");
      return;
    }
    fetch(`https://4frvp3-169-150-209-165.ru.tuna.am/api/order_details?order_id=${orderId}`)
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          const order = data.order;
          // Заполняем поля в модальном окне
          document.getElementById('orderNumber').innerText = order.orderNumber || `Заказ №${order.id}`;
          document.getElementById('orderDescription').innerText = `Композиция: "${order.description || compositionNameLS}"`;

          // Если в БД уже есть данные о доставке
          const delInfo = order.delivery_type
            ? `Доставка: ${order.delivery_type}, ${order.delivery_address}, ${order.delivery_time}`
            : "Доставка: не указана";
          document.getElementById('deliveryInfo').innerText = delInfo;

          // Если в БД есть поле total, используем его. Иначе считаем (price + deliveryPrice).
          // Предположим, что в orders или responses хранится цена.
          const total = order.total || 1000; // <-- нужно адаптировать к вашей логике
          document.getElementById('orderTotal').innerText = `Итого: ${total} руб.`;
          document.getElementById('confirmPaymentBtn').innerText = `Оплатить ${total} руб.`;
        } else {
          console.error("Ошибка при получении заказа:", data.message);
        }
      })
      .catch(err => {
        console.error("Ошибка fetch:", err);
      });
  }

  loadOrderDetails();

  /* --- Открыть модальное окно --- */
  function openCheckout() {
    document.getElementById('checkoutModal').style.display = 'flex';
  }
  function closeCheckout() {
    document.getElementById('checkoutModal').style.display = 'none';
  }

  document.getElementById('payBtn').addEventListener('click', openCheckout);

  /* --- Редактирование полей (delivery, name, phone) --- */
  function openSubModal(mode) {
    document.getElementById('subModal').style.display = 'flex';
    const subTitle = document.getElementById('subModalTitle');
    const subInput = document.getElementById('subModalInput');
    subInput.value = ""; // очищаем на всякий случай

    if (mode === 'delivery') {
      subTitle.innerText = "Информация о доставке";
      subInput.placeholder = "Введите адрес доставки";
    } else if (mode === 'name') {
      subTitle.innerText = "Имя";
      subInput.placeholder = "Введите ваше имя";
    } else if (mode === 'phone') {
      subTitle.innerText = "Телефон";
      subInput.placeholder = "Введите ваш телефон";
    }

    subInput.setAttribute('data-mode', mode);
  }

  function closeSubModal() {
    const subInput = document.getElementById('subModalInput');
    const mode = subInput.getAttribute('data-mode');
    const value = subInput.value.trim();
    if (!value) {
      // Ничего не ввели
      document.getElementById('subModal').style.display = 'none';
      return;
    }

    // Обновляем UI и отправляем на сервер
    if (mode === 'delivery') {
      document.getElementById('deliveryInfo').innerText = value;
      updateOrderField({ delivery_address: value }); // пример
    } else if (mode === 'name') {
      console.log("Имя:", value);
      updateOrderField({ recipient_name: value });
    } else if (mode === 'phone') {
      console.log("Телефон:", value);
      updateOrderField({ recipient_phone: value });
    }

    document.getElementById('subModal').style.display = 'none';
    subInput.value = "";
  }

  /* --- Функция для обновления полей в БД --- */
  function updateOrderField(fieldsObj) {
    if (!orderId) return;
    // Например, вызываем /api/update_order
    // Передаём order_id и нужные поля
    const body = { order_id: orderId, ...fieldsObj };

    fetch("https://4frvp3-169-150-209-165.ru.tuna.am/api/update_order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        console.log("Поля заказа обновлены:", fieldsObj);
      } else {
        console.error("Ошибка update_order:", data.message);
      }
    })
    .catch(err => console.error("Ошибка fetch update_order:", err));
  }

  /* --- Подтверждение оплаты --- */
  function confirmPayment() {
    // Пример: отправляем запрос на /api/pay_order, чтобы выставить статус = 'paid'
    fetch("https://4frvp3-169-150-209-165.ru.tuna.am/api/pay_order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order_id: orderId })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "success") {
        alert("Оплата прошла успешно!");
        // Закрываем модальное окно
        closeCheckout();
        // Можно Telegram.WebApp.close() или перенаправить
        // tg.close();
      } else {
        alert("Ошибка при оплате: " + data.message);
      }
    })
    .catch(err => {
      alert("Сетевая ошибка при оплате");
      console.error(err);
    });
  }

  /* --- Переход на детали исполнителя --- */
  document.getElementById('showPartnerDetailsBtn').addEventListener('click', () => {
    if (selectedPartner && selectedPartner.id) {
      window.location.href = `partner_details.html?partner_id=${selectedPartner.id}&order_id=${orderId}`;
    } else {
      alert("Данные исполнителя отсутствуют.");
    }
  });
</script>
</body>
</html>
